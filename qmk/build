#!/usr/bin/env bash

set -euo pipefail

KEYBOARDS=(
  keebio/sinc/rev3
  keebio/quefrency/rev4
  annepro2/c18
)

function main() {
  ./install-symlinks

  if [ "${1:-}" == "all" ]; then
    qmk-compile "${KEYBOARDS[@]}"
  elif [ $# -gt 0 ]; then
    qmk-compile "$@"
  else
    qmk-compile "$(pick-keyboard)"
  fi
}

function qmk-compile() {
  for kb in "$@"; do
    qmk compile -kb "$kb" -km elentok
    kb_basename="$(echo "$kb" | tr / _)"
    cp -f "$HOME/qmk_firmware/${kb_basename}_elentok".* ./binaries
  done
}

function pick-keyboard() {
  list-keyboards | fzf-tmux -p
}

function list-keyboards() {
  for kb in "${KEYBOARDS[@]}"; do
    echo "$kb"
  done
}

main "$@"
